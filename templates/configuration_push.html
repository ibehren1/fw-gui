{% extends "basic_page.html" %}
{% block body %}
<div class="config-push">
    <div class="push-header">
        <h2 class="section-title">Push Firewall Configuration</h2>
        <p class="section-description">
            Connect to your firewall via SSH to view configuration differences and deploy changes. 
            Credentials are <strong>not saved</strong> and must be provided each time.
        </p>
    </div>
    
    {% with flashed_messages = get_flashed_messages(with_categories=true) %}
    {% if flashed_messages %}
    <div class="flash-messages">
        {% for category, flash_message in flashed_messages %}
        <div class="alert alert-{{ category }}">
            {{flash_message}}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}
    
    <div class="push-grid">
        <!-- Connection Status -->
        <div class="connection-card">
            <h3 class="subsection-title">Firewall Connection</h3>
            
            <div class="connection-status">
                <div class="status-item">
                    <span class="status-label">Hostname:</span>
                    <div class="status-value">
                        <span class="status-indicator {{ 'online' if firewall_reachable else 'offline' }}"></span>
                        {{ firewall_hostname if firewall_hostname else 'Not configured' }}
                    </div>
                </div>
                
                <div class="status-item">
                    <span class="status-label">SSH Port:</span>
                    <span class="status-value">{{ firewall_port if firewall_port else '22' }}</span>
                </div>
            </div>
            
            <form action="/configuration_push_hostname" method="post" class="hostname-form">
                <div class="form-group">
                    <label for="hostname" class="form-label">Firewall Hostname/IP</label>
                    <input type="text" name="hostname" id="hostname" class="form-input" 
                           value="{{ firewall_hostname if firewall_hostname else '' }}" 
                           placeholder="192.168.1.1 or firewall.example.com" required>
                </div>
                
                <div class="form-group">
                    <label for="port" class="form-label">SSH Port</label>
                    <input type="number" name="port" id="port" class="form-input" 
                           value="{{ firewall_port if firewall_port else '22' }}" 
                           min="1" max="65535">
                </div>
                
                <button type="submit" class="btn btn-secondary full-width">Update Connection</button>
            </form>
        </div>
        
        <!-- Authentication -->
        <div class="auth-card">
            <h3 class="subsection-title">Authentication</h3>
            
            <form action="/configuration_push_auth" method="post" class="auth-form">
                <div class="form-group">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" name="username" id="username" class="form-input" 
                           placeholder="SSH username" required>
                </div>
                
                <div class="form-group">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" name="password" id="password" class="form-input" 
                           placeholder="SSH password" required>
                </div>
                
                <div class="auth-actions">
                    <button type="submit" name="action" value="test" class="btn btn-secondary">Test Connection</button>
                    <button type="submit" name="action" value="diff" class="btn btn-primary">View Diff</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Configuration Preview -->
    {% if config_preview %}
    <div class="config-preview">
        <h3 class="subsection-title">Configuration to Deploy</h3>
        <div class="preview-toolbar">
            <button onclick="copyConfig()" class="btn btn-secondary">Copy Configuration</button>
            <span class="config-size">{{ config_lines }} lines</span>
        </div>
        <pre class="configuration" id="config-preview">{{ config_preview }}</pre>
    </div>
    {% endif %}
    
    <!-- Deployment Options -->
    {% if authenticated %}
    <div class="deployment-card">
        <h3 class="subsection-title">Deployment Options</h3>
        <p class="deployment-warning">
            <strong>Warning:</strong> Committing changes will modify your firewall configuration. 
            Ensure you have reviewed the differences before proceeding.
        </p>
        
        <form action="/configuration_push_commit" method="post" class="deployment-form">
            <div class="deployment-options">
                <label class="checkbox-item">
                    <input type="checkbox" name="delete_existing" value="true">
                    <span class="checkbox-label">Delete existing firewall configuration first</span>
                    <small class="option-help">Use only if managing ALL firewall rules via FW-GUI</small>
                </label>
            </div>
            
            <div class="deployment-actions">
                <button type="submit" name="action" value="commit" class="btn btn-primary" 
                        onclick="return confirm('Are you sure you want to commit these changes to the firewall?')">
                    Commit Changes
                </button>
                <button type="submit" name="action" value="dry-run" class="btn btn-secondary">
                    Dry Run (Test Only)
                </button>
            </div>
        </form>
    </div>
    {% endif %}
</div>

<script>
function copyConfig() {
    const text = document.getElementById('config-preview').textContent;
    navigator.clipboard.writeText(text).then(function() {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        btn.classList.add('btn-success');
        setTimeout(() => {
            btn.textContent = originalText;
            btn.classList.remove('btn-success');
        }, 2000);
    });
}
</script>

<style>
.config-push {
    max-width: 1200px;
}

.push-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

.connection-card, .auth-card, .deployment-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: var(--border-radius);
    padding: 1.5rem;
}

.connection-status {
    margin-bottom: 1.5rem;
}

.status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.status-item:last-child {
    border-bottom: none;
}

.status-label {
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
}

.status-value {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--primary-color);
    font-weight: 600;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.status-indicator.online {
    background: var(--success-color);
}

.status-indicator.offline {
    background: var(--danger-color);
}

.auth-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.config-preview {
    background: rgba(255, 255, 255, 0.05);
    border-radius: var(--border-radius);
    margin-bottom: 2rem;
    overflow: hidden;
}

.preview-toolbar {
    background: rgba(0, 0, 0, 0.2);
    padding: 0.75rem 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.config-size {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.9rem;
}

.deployment-warning {
    background: rgba(247, 212, 35, 0.1);
    border: 1px solid var(--warning-color);
    color: var(--warning-color);
    padding: 1rem;
    border-radius: var(--border-radius);
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
}

.deployment-options {
    margin-bottom: 1.5rem;
}

.option-help {
    display: block;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

.deployment-actions {
    display: flex;
    gap: 1rem;
}

@media (max-width: 768px) {
    .push-grid {
        grid-template-columns: 1fr;
    }
    
    .auth-actions, .deployment-actions {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock body %}
